/*! jQuery Tree - v0.2.0 - 2013-07-03
* https://github.com/amazingSurge/jquery-tree
* Copyright (c) 2013 amazingSurge; Licensed GPL */
(function(t){var e=function(){var e=function(t){this.tpl=t.tpl};return e.prototype={constructor:e,getLeaf:function(t){return t.html()},getBranch:function(t){return t.children("div").html()},renderTree:function(e,n,i){var r,s=this;if(n?(r=e,e.addClass("tree")):r=e.children("ul"),0!==r.length){e.addClass("tree-branch");var a=function(e){e.children("li").each(function(e,n){var r=t(n),a=s.tpl.branch(s.getBranch(r));r.children("div").replaceWith(a),s.renderTree(r,!1,i)})};a(r)}}},e}(),n=function(){var t=function(t){this.tpl=t.tpl};return t.prototype={constructor:t,getLeaf:function(t){var e=this.tpl.leaf(t);return"<li>"+e+"</li>"},getBranch:function(t){var e=this.tpl.branch(t),n=this.getTree(t.children);return'<li class="tree-branch">'+e+n+"</li>"},getNode:function(t){return t.children?this.getBranch(t):this.getLeaf(t)},getTree:function(t,e){var n="";for(var i in t)n+=this.getNode(t[i]);return e?'<ul class="tree">'+n+"</ul>":"<ul>"+n+"</ul>"}},t}(),i=function(){var e=function(t,e,n){this.$dom=t,this.api=n,null==e&&(e=!1),e?this.type="root":(this.selected=!1,this.hasChildren()?(this.type="branch",this.opened=this.isOpened()):this.type="leaf"),this.init()};return e.prototype={init:function(){switch(this.type){case"root":this._children=this.$dom.get(0).children,this.level=0,this.parent=null,this.$parent=null;break;case"branch":case"leaf":var t=this.$dom.children("ul");this._children=t.length>0?t.get(0).children:[],this.$parent=this.$dom.parents("li.tree-branch").eq(0),0===this.$parent.length&&(this.$parent=this.$dom.parent()),this.parent=this.$parent.data("node"),this.level=this.parent.level+1}},get:function(){return this.$dom},position:function(){var t=[],e=function(n){t.push(n.$dom.index()+1),n.parent&&"root"!==n.parent.type&&e(n.parent)};return e(this),t.reverse()},parents:function(){var t=[],e=function(n){null!==n.parent&&(t.push(n.parent),e(n.parent))};return e(this),t},children:function(){for(var e,n=[],i=0;this._children.length>i;i++)e=t(this._children[i]).data("node"),e&&n.push(e);return n},siblings:function(){for(var t,e=[],n=this.$dom.siblings(),i=0;n.length>i;i++)t=n.data("node"),t&&e.push(t);return e},hasChildren:function(){return 0!==this.$dom.children("ul").children("li").length},isOpened:function(){return this.opened===void 0?this.$dom.is(".tree-open"):this.opened},open:function(t){if(this.opened=!0,this.$dom.addClass("tree-open"),t)for(var e=this.parents(),n=0;e.length>n;n++)"root"!==e[n].type&&e[n].open();return this},close:function(t){if(this.opened=!1,this.$dom.removeClass("tree-open"),t)for(var e=this.children(),n=0;e.length>n;n++)"branch"===e[n].type&&e[n].close(!0);return this},toggleOpen:function(){return this.opened?this.close():this.open(),this},toggleSelect:function(t){return t?this.selected?(this.unselect(),!1):(this.select(),!0):(this.select(),!0)},select:function(){return this.selected=!0,this.$dom.addClass("tree-selected"),this},unselect:function(){return this.selected=!1,this.$dom.removeClass("tree-selected"),this},toBranch:function(){if("leaf"===this.type){var t=this.$dom.html();this.$dom.addClass("tree-branch"),this.$dom.html(this.api.options.tpl.branch(t)+"<ul></ul>")}return this},append:function(e){"leaf"===this.type&&this.toBranch();var n=this.api.dataParser.getNode(e),i=t(n).appendTo(this.$dom.children("ul"));return"leaf"===this.type?this.api.attach(this.$dom,!1,this.api):this.api.attach(i,!1,this.api),this},prepend:function(e){"leaf"===this.type&&this.toBranch();var n=this.api.dataParser.getNode(e),i=t(n).prependTo(this.$dom.children("ul"));return"leaf"===this.type?this.api.attach(this.$dom,!1,this.api):this.api.attach(i,!1,this.api),this},after:function(t){var e=this.api.dataParser.getNode(t);this.$dom.after(e);var n=this.$dom.next();return this.api.attach(n,!1,this.api),this},before:function(t){var e=this.api.dataParser.getNode(t);this.$dom.before(e);var n=this.$dom.prev();return this.api.attach(n,!1,this.api),this},remove:function(){return this.$dom.remove(),this}},e}(),r=function(){var r=t.tree=function(i,s){this.$el=t(i),this.options=t.extend(!0,{},r.defaults,s),this.namespace=this.options.namespace,this.dataParser=new n(this.options),this.htmlParser=new e(this.options),this._init()};return r.defaults={namespace:"tree",autoOpen:[1,2],dataFromHtml:!1,data:null,multiSelect:!1,deselect:!1,tpl:{toggler:function(){return'<i class="tree-toggler"></i>'},branch:function(t){var e=this.branchContent(t),n=this.toggler(t);return'<div class="tree-element">'+n+'<div class="element-content">'+e+"</div>"+"</div>"},branchContent:function(t){return"object"==typeof t?t.name:t},leaf:function(t){var e=this.leafContent(t);return e},leafContent:function(t){return"object"==typeof t?t.name:t}}},r.prototype={constructor:r,_init:function(){this.options.dataFromHtml===!0?this._createFromHtml():this._createFromData();var e="ul"===this.$el[0].nodeName.toLowerCase()?this.$el:this.$el.find("ul:first");this.root=e.data("node"),this.selected=this.options.multiSelect?[]:null,this.autoOpen(),this.$el.on({click:t.proxy(this._click,this)})},_createFromHtml:function(){var t="ul"===this.$el[0].nodeName.toLowerCase()?this.$el:this.$el.find("ul:first");this.htmlParser.renderTree(t,!0,this),this.attach(t,!0,this)},_createFromData:function(){var t="";this.options.data&&(t=this.dataParser.getTree(this.options.data,!0)),this.$el.html(t),this.attach(this.$el.children("ul"),!0,this)},_click:function(e){var n=t(e.target).closest(".tree-toggler, li"),i=t(e.target).closest("li"),r=i.data("node");switch(n.attr("class")){case"tree-toggler":r.toggleOpen(),this.options.multiSelect||i.find("li").hasClass("tree-selected")&&(r.opened?i.removeClass("children-selected"):i.addClass("children-selected"));break;default:var s=r.toggleSelect(this.options.deselect);this.options.multiSelect?s?this.selected.push(r):this.selected=t.grep(this.selected,function(t){return t.$dom!==r.$dom}):(this.selected&&(this.options.deselect?this.selected.unselect():this.selected!==r&&this.selected.unselect()),this.selected=s?r:null)}},attach:function(e,n,r){var s=this;e.data("node",new i(e,n,r));var a;if(a=n?e:e.children("ul"),0!==a.length){var h=function(e){e.children("li").each(function(e,n){var i=t(n);s.attach(i,!1,r)})};h(a)}},open:function(t,e){var n=this.get(t);return n&&n.open(e),this},close:function(t,e){var n=this.get(t);return n&&n.close(e),this},select:function(t){var e=this.get(t);return e&&e.select(),this},unselect:function(t){var e=this.get(t);return e&&e.unselect(),this},get:function(e){t.isArray(e)||(e=[]);try{for(var n=function(e,n){return t(e._children[n]).data("node")},i=this.root,r=0;e.length>r;r++)i=n(i,e[r]-1)}catch(s){return null}return i},getRoot:function(){return this.root},getSelected:function(){return this.selected},autoOpen:function(){var e=this,n=this.root.$dom;switch(typeof e.options.autoOpen){case"boolean":n.find("li").each(function(n,i){var r=t(i),s=r.data("node");e.options.autoOpen===!0&&"branch"===s.type&&s.open()});break;case"number":n.find("li").each(function(n,i){var r=t(i),s=r.data("node");"branch"===s.type&&s.level<=e.options.autoOpen&&s.open()});break;case"object":t.isArray(e.options.autoOpen)&&this.get(e.options.autoOpen).open(!0)}},append:function(t,e){var n=this.get(t);return n&&n.append(e),this},prepend:function(t,e){var n=this.get(t);return n&&n.prepend(e),this},after:function(t,e){var n=this.get(t);return n&&n.after(e),this},before:function(t,e){var n=this.get(t);return n&&n.before(e),this},remove:function(t){var e=this.get(t);return e&&e.remove(data),this}},r}();t.fn.tree=function(e){if("string"!=typeof e)return this.each(function(){t.data(this,"tree")||t.data(this,"tree",new r(this,e))});var n=e,i=arguments.length>1?Array.prototype.slice.call(arguments,1):void 0;if(!/^(getRoot|get|getSelected)$/.test(n))return this.each(function(){var e=t.data(this,"tree");e&&"function"==typeof e[n]&&e[n].apply(e,i)});var s=this.first().data("tree");return s&&"function"==typeof s[n]?s[n].apply(s,i):void 0}})(jQuery);