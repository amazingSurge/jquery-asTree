/*! jQuery Tree - v0.2.0 - 2013-07-03
* https://github.com/amazingSurge/jquery-tree
* Copyright (c) 2013 amazingSurge; Licensed GPL */
(function(t){var e=function(){var e=function(t){this.tpl=t.tpl};return e.prototype={constructor:e,getLeaf:function(t){return t.html()},getBranch:function(t){return t.children("div").html()},renderTree:function(e,i,n){var r,s=this;if(i?(r=e,e.addClass("tree")):r=e.children("ul"),0!==r.length){e.addClass("tree-branch");var a=function(e){e.children("li").each(function(e,i){var r=t(i),a=s.tpl.branch(s.getBranch(r));r.children("div").replaceWith(a),s.renderTree(r,!1,n)})};a(r)}}},e}(),i=function(){var t=function(t){this.tpl=t.tpl};return t.prototype={constructor:t,getLeaf:function(t){var e=this.tpl.leaf(t);return"<li>"+e+"</li>"},getBranch:function(t){var e=this.tpl.branch(t),i=this.getTree(t.children);return'<li class="tree-branch">'+e+i+"</li>"},getNode:function(t){return t.children?this.getBranch(t):this.getLeaf(t)},getTree:function(t,e){var i="";for(var n in t)i+=this.getNode(t[n]);return e?'<ul class="tree">'+i+"</ul>":"<ul>"+i+"</ul>"}},t}(),n=function(){var e=function(t,e,i){this.$dom=t,this.api=i,null==e&&(e=!1),e?this.type="root":(this.selected=!1,this.hasChildren()?(this.type="branch",this.opened=this.isOpened()):this.type="leaf"),this.init()};return e.prototype={init:function(){switch(this.type){case"root":this._children=this.$dom.get(0).children,this.level=0,this.parent=null,this.$parent=null;break;case"branch":case"leaf":var t=this.$dom.children("ul");this._children=t.length>0?t.get(0).children:[],this.$parent=this.$dom.parents("li.tree-branch").eq(0),0===this.$parent.length&&(this.$parent=this.$dom.parent()),this.parent=this.$parent.data("node"),this.level=this.parent.level+1}},get:function(){return this.$dom},position:function(){var t=[],e=function(i){t.push(i.$dom.index()+1),i.parent&&"root"!==i.parent.type&&e(i.parent)};return e(this),t.reverse()},parents:function(){var t=[],e=function(i){null!==i.parent&&(t.push(i.parent),e(i.parent))};return e(this),t},children:function(){for(var e,i=[],n=0;this._children.length>n;n++)e=t(this._children[n]).data("node"),e&&i.push(e);return i},siblings:function(){for(var t,e=[],i=this.$dom.siblings(),n=0;i.length>n;n++)t=i.data("node"),t&&e.push(t);return e},hasChildren:function(){return 0!==this.$dom.children("ul").children("li").length},isOpened:function(){return this.opened===void 0?this.$dom.is(".tree_open"):this.opened},open:function(t){if(this.opened=!0,this.$dom.addClass("tree_open"),t)for(var e=this.parents(),i=0;e.length>i;i++)"root"!==e[i].type&&e[i].open();return!this.api.options.multiSelect&&this.hasChildrenSelect()&&this.$dom.removeClass("tree_childrenSelected"),this},close:function(t){if(this.opened=!1,this.$dom.removeClass("tree_open"),t)for(var e=this.children(),i=0;e.length>i;i++)"branch"===e[i].type&&e[i].close(!0);return!this.api.options.multiSelect&&this.hasChildrenSelect()&&this.$dom.addClass("tree_childrenSelected"),this},hasChildrenSelect:function(){return 0!==this.$dom.find("li.tree_selected").length},toggleOpen:function(){return this.opened?this.close():this.open(),this},toggleSelect:function(){return this.selected?this.unselect():this.select(),this},select:function(){return this.selected=!0,this.$dom.addClass("tree_selected"),this.api.options.multiSelect?this.api.selected.push(this):(this.api.selected&&this.api.selected.unselect(!0),this.api.selected=this),this},unselect:function(e){if(this.api.options.canUnselect||e)if(this.selected=!1,this.$dom.removeClass("tree_selected"),this.api.options.multiSelect){var i=this;this.api.selected=t.grep(this.api.selected,function(t){return t.$dom!==i.$dom})}else this.api.selected=null;return this},toBranch:function(){if("leaf"===this.type){var t=this.$dom.html();this.$dom.addClass("tree-branch"),this.$dom.html(this.api.options.tpl.branch(t)+"<ul></ul>")}return this},append:function(e){"leaf"===this.type&&this.toBranch();var i=this.api.dataParser.getNode(e),n=t(i).appendTo(this.$dom.children("ul"));return"leaf"===this.type?this.api.attach(this.$dom,!1,this.api):this.api.attach(n,!1,this.api),this},prepend:function(e){"leaf"===this.type&&this.toBranch();var i=this.api.dataParser.getNode(e),n=t(i).prependTo(this.$dom.children("ul"));return"leaf"===this.type?this.api.attach(this.$dom,!1,this.api):this.api.attach(n,!1,this.api),this},after:function(t){var e=this.api.dataParser.getNode(t);this.$dom.after(e);var i=this.$dom.next();return this.api.attach(i,!1,this.api),this},before:function(t){var e=this.api.dataParser.getNode(t);this.$dom.before(e);var i=this.$dom.prev();return this.api.attach(i,!1,this.api),this},remove:function(){return this.$dom.remove(),this}},e}(),r=function(){var r=t.tree=function(n,s){this.$el=t(n),this.options=t.extend(!0,{},r.defaults,s),this.namespace=this.options.namespace,this.dataParser=new i(this.options),this.htmlParser=new e(this.options),this._init()};return r.defaults={namespace:"tree",autoOpen:[1,2],dataFromHtml:!1,data:null,multiSelect:!1,canUnselect:!0,tpl:{toggler:function(){return'<i class="tree-toggler"></i>'},branch:function(t){var e=this.branchContent(t),i=this.toggler(t);return'<div class="tree-element">'+i+'<div class="element-content">'+e+"</div>"+"</div>"},branchContent:function(t){return"object"==typeof t?t.name:t},leaf:function(t){var e=this.leafContent(t);return e},leafContent:function(t){return"object"==typeof t?t.name:t}}},r.prototype={constructor:r,_init:function(){this.options.dataFromHtml===!0?this._createFromHtml():this._createFromData();var e="ul"===this.$el[0].nodeName.toLowerCase()?this.$el:this.$el.find("ul:first");this.root=e.data("node"),this.selected=this.options.multiSelect?[]:null,this.autoOpen(),this.$el.on({click:t.proxy(this._click,this)})},_createFromHtml:function(){var t="ul"===this.$el[0].nodeName.toLowerCase()?this.$el:this.$el.find("ul:first");this.htmlParser.renderTree(t,!0,this),this.attach(t,!0,this)},_createFromData:function(){var t="";this.options.data&&(t=this.dataParser.getTree(this.options.data,!0)),this.$el.html(t),this.attach(this.$el.children("ul"),!0,this)},_click:function(e){var i=t(e.target).closest(".tree-toggler, li"),n=t(e.target).closest("li"),r=n.data("node");switch(i.attr("class")){case"tree-toggler":r.toggleOpen();break;default:r.toggleSelect()}},attach:function(e,i,r){var s=this;e.data("node",new n(e,i,r));var a;if(a=i?e:e.children("ul"),0!==a.length){var h=function(e){e.children("li").each(function(e,i){var n=t(i);s.attach(n,!1,r)})};h(a)}},open:function(t,e){var i=this.get(t);return i&&i.open(e),this},close:function(t,e){var i=this.get(t);return i&&i.close(e),this},select:function(t){var e=this.get(t);return e&&e.select(),this},unselect:function(t){var e=this.get(t);return e&&e.unselect(),this},get:function(e){t.isArray(e)||(e=[]);try{for(var i=function(e,i){return t(e._children[i]).data("node")},n=this.root,r=0;e.length>r;r++)n=i(n,e[r]-1)}catch(s){return null}return n},getRoot:function(){return this.root},getSelected:function(){return this.selected},autoOpen:function(){var e=this,i=this.root.$dom;switch(typeof e.options.autoOpen){case"boolean":i.find("li").each(function(i,n){var r=t(n),s=r.data("node");e.options.autoOpen===!0&&"branch"===s.type&&s.open()});break;case"number":i.find("li").each(function(i,n){var r=t(n),s=r.data("node");"branch"===s.type&&s.level<=e.options.autoOpen&&s.open()});break;case"object":t.isArray(e.options.autoOpen)&&this.get(e.options.autoOpen).open(!0)}},append:function(t,e){var i=this.get(t);return i&&i.append(e),this},prepend:function(t,e){var i=this.get(t);return i&&i.prepend(e),this},after:function(t,e){var i=this.get(t);return i&&i.after(e),this},before:function(t,e){var i=this.get(t);return i&&i.before(e),this},remove:function(t){var e=this.get(t);return e&&e.remove(data),this}},r}();t.fn.tree=function(e){if("string"!=typeof e)return this.each(function(){t.data(this,"tree")||t.data(this,"tree",new r(this,e))});var i=e,n=arguments.length>1?Array.prototype.slice.call(arguments,1):void 0;if(!/^(getRoot|get|getSelected)$/.test(i))return this.each(function(){var e=t.data(this,"tree");e&&"function"==typeof e[i]&&e[i].apply(e,n)});var s=this.first().data("tree");return s&&"function"==typeof s[i]?s[i].apply(s,n):void 0}})(jQuery);